name: Angular CI/CD

on:
  push:
    branches: [master]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ANGULAR_ENV

    steps:
      # 1ï¸âƒ£ Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3ï¸âƒ£ Install dependencies
      - name: Install dependencies
        run: npm ci

      # 4ï¸âƒ£ Build Angular production
      - name: Build Angular app
        run: npm run build -- --configuration production

      # 5ï¸âƒ£ Login to Docker Registry
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # 6ï¸âƒ£ Build and tag Docker image
      - name: Build Docker image
        run: |
          docker build -t chansy/angular-app:${{ github.sha }} .
          docker tag chansy/angular-app:${{ github.sha }} chansy/angular-app:latest

      # 7ï¸âƒ£ Push Docker image
      - name: Push Docker image
        run: |
          docker push chansy/angular-app:${{ github.sha }}
          docker push chansy/angular-app:latest

      # 8ï¸âƒ£ Setup kubeconfig for remote cluster
      - name: Setup kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config

      # 9ï¸âƒ£ Test Kubernetes access
      - name: Test Kubernetes access
        run: kubectl get nodes

      # ğŸ”Ÿ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        run: |
          echo "Replacing IMAGE_TAG with commit SHA in deployment.yml"
          sed -i "s|IMAGE_TAG|${GITHUB_SHA}|g" k8s/deployment.yml

          echo "Applying Kubernetes manifests"
          kubectl apply -f k8s/
